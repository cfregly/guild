<link rel="import" href="../guild-util/guild-util.html">

<link rel="import" href="guild-data.html">

<script>
 var Guild = Guild || {};
 Guild.DataListener = {

     properties: {
         env: Object,
         dataSource: String,
         dataAttribute: String,
         dataReduce: String,
         dataFormat: String,
         dataFetchInterval: Number,
         _pendingFetch: {
             type: Object,
             value: null
         }
     },

     ready: function() {
         if (this.dataFetchInterval == undefined) {
             this.dataFetchInterval = this.env.settings.refreshInterval || 0;
         }
         this.scheduleFetch(0);
     },

     scheduleFetch: function(whenSeconds) {
         if (this.dataSource) {
             var url = this.dataFetchUrl();
             var handler = this.handleFetchResult.bind(this);
             this.cancelPendingFetch();
             this._pendingFetch =
                 Guild.Data.scheduleFetch(url, handler, whenSeconds * 1000);
         }
     },

     dataFetchUrl: function() {
         var base = "/data/" + this.dataSource;
         var runParam = "run=" + this.env.runId;
         return base.indexOf("?") == -1
              ? base + "?" + runParam
              : base + "&" + runParam;
     },

     handleFetchResult: function(result) {
         if (result != null) {
             var data = this.maybeReduce(result);
             this.handleData.bind(this)(data);
         }
         this.maybeScheduleNextFetch();
     },

     cancelPendingFetch: function() {
         if (this._pendingFetch) {
             window.clearTimeout(this._pendingFetch);
             this._pendingFetch = null;
         }
     },

     maybeScheduleNextFetch: function() {
         var interval = this.dataFetchInterval;
         if (interval > 0 && this.repeatData.bind(this)()) {
             this.scheduleFetch(interval);
         }
     },

     repeatData: function() {
         return false;
     },

     maybeReduce: function(data) {
         var reduce = Guild.Reduce[this.dataReduce];
         return reduce ? reduce(data) : data;
     },

     handleData: function(data) {
         // stub to be overridden by host
     },

     formatDataValue: function(data, defaultValue) {
         var val = this.dataValue(data);
         if (val != undefined) {
             return Guild.Util.tryFormat(val, this.dataFormat);
         } else {
             return defaultValue;
         }
     },

     dataValue: function(data) {
         if (typeof data === "object" && data != null) {
            return data[Object.keys(data)[0]];
        } else {
            return data;
        }
     }
 };
</script>
