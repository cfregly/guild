<link rel="import" href="../guild-component-panel/guild-component-panel.html">
<link rel="import" href="../guild-data/guild-data-listener.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../vz-line-chart/vz-line-chart.html">

<dom-module id="guild-chart">
  <template>
    <style>
     #container {
         background-color: #fff;
         padding: 20px 10px 20px 0;
         height: 260px;
         display: flex;
         align-items: stretch;
     }
     paper-icon-button {
         color: var(--disabled-text-color);
     }
    </style>
    <guild-component-panel id="panel" heading="[[title]]">
      <div class="actions">
        <paper-icon-button
            icon="[[fullscreenIcon]]"
            on-click="toggleFullscreen">
        </paper-icon-button>
      </div>
      <div id="container">
        <vz-line-chart id="chart" x-type="wall_time"></vz-line-chart>
      </div>
    </guild-component-panel>
  </template>
  <script>
   Polymer({
       is: "guild-chart",

       properties: {
           title: String,
           fullscreen: {
               type: Boolean,
               value: false,
               notify: true,
               observer: 'fullscreenChanged'
           },
           fullscreenIcon: {
               type: String,
               computed: 'computeFullscreenIcon(fullscreen)'
           }
       },

       behaviors: [Guild.DataListener],

       listeners: {
           'guild-fullscreen-canceled': 'handleFullscreenCanceled'
       },

       handleData: function(data) {
           var names = Object.keys(data);
           this.$.chart.setVisibleSeries(names);
           names.forEach(function(name) {
               var seriesData = this.seriesData(name, data);
               this.$.chart.setSeriesData(name, seriesData);
           }.bind(this));
       },

       repeatData: function() {
           return Guild.Run.isRunning(this.env.run);
       },

       seriesData: function(name, data) {
           return data[name].map(function(item, index) {
               return {
                   wall_time: new Date(item[0]),
                   step: item[1] || index,
                   scalar: item[2]
               }
           });
       },

       computeFullscreenIcon: function(fullscreen) {
           return fullscreen ? "fullscreen-exit" : "fullscreen";
       },

       toggleFullscreen: function() {
           this.fullscreen = !this.fullscreen;
       },

       fullscreenChanged: function(val, old) {
           if (old == undefined) {
               return;
           }
           this.$.container.style.height = this.chartHeight(val);
           this.updateStyles();
           this.$.panel.noToggle = val;
           this.$.panel.opened = true;
           this.fire(this.fullscreenEvent(val));
       },

       chartHeight: function(fullscreen) {
           return fullscreen ? '520px' : '260px';
       },

       fullscreenEvent: function(fullscreen) {
           return fullscreen ? "guild-fullscreen" : "guild-exit-fullscreen";
       },

       handleFullscreenCanceled: function(e) {
           this.fullscreen = false;
       }
   });
  </script>
</dom-module>
