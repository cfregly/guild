<link rel="import" href="../app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../app-layout/app-header/app-header.html">
<link rel="import" href="../app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../guild-event/guild-event.html">
<link rel="import" href="../guild-icons/guild-icons.html">
<link rel="import" href="../guild-imports/bootstrap-grid.html">
<link rel="import" href="../guild-run/guild-run.html">
<link rel="import" href="../guild-run/guild-runs-listener.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">

<link rel="import" href="404-page.html">
<link rel="import" href="guild-view-page.html">
<link rel="import" href="modal-message.html">
<link rel="import" href="fullscreen-overlay.html">

<dom-module id="guild-view">
  <template>
    <style>
     :root {
         --toolbar-color: #48484e;
         --toolbar-text-color: #fff;
         --toolbar-text-accent-color: #ddd;
         --toolbar-tab-ink: #ccc;
         --vz-chart-tooltip: {
             border-radius: 2px;
             background-color: var(--paper-tooltip-background, #616161);
         };
         --paper-tooltip: {
             font-size: 12px;
         };
     }

     app-toolbar {
         background-color: var(--toolbar-color);
         color: var(--toolbar-text-color);
         border-bottom: 1px solid var(--toolbar-text-accent-color);
     }

     .drawer-toolbar {
         --paper-toolbar-background: transparent;
     }

     paper-tabs {
         color: var(--toolbar-text-color);
         margin-left: 20px;
         font-size: 14px;
         height: 40px;
         --paper-tabs-selection-bar-color: var(--toolbar-text-accent-color);
     }

     paper-tab {
         --paper-tab-ink: var(--toolbar-tab-ink);
     }

     .tab-icon, .menu-icon {
         --iron-icon-width: 24px;
         --iron-icon-height: 24px;
         margin-right: 5px;
     }

     app-toolbar a {
         text-decoration: none;
         color: var(--toolbar-text-color);
     }

     .fullscreen {
         display: block;
         z-index: 9999;
         position: fixed;
         width: 100%;
         height: 100%;
         top: 0;
         right: 0;
         left: 0;
         bottom: 0;
         overflow: auto;
     }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:id"
        data="{{currentPage}}"
        query-params="{{queryParams}}"
        tail="{{routeTail}}"></app-route>

    <modal-message id="dialog"></modal-message>
    <fullscreen-overlay id="fullscreen"></fullscreen-overlay>

    <app-drawer-layout narrow="{{narrow}}">
      <app-drawer id="drawer" hidden$="[[!narrow]]">
        <paper-toolbar class="drawer-toolbar"></paper-toolbar>
        <paper-menu selected="{{currentPage.id}}" attr-for-selected="page">
          <template is="dom-repeat" items="[[env.viewdef.pages]]" as="page">
            <paper-item page="[[page.id]]" on-tap="closeDrawer">
              <iron-icon class="menu-icon" icon="[[page.icon]]"></iron-icon>
              [[page.label]]
            </paper-item>
          </template>
        </paper-menu>
      </app-drawer>

      <app-header-layout>
        <app-header reveals>
          <app-toolbar>
            <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <div><a href="javascript:window.location='/'">Guild View</a></div>
            <paper-tabs hidden$="[[narrow]]" selected="{{currentPage.id}}" attr-for-selected="page-id">
              <template is="dom-repeat" items="[[env.viewdef.pages]]" as="page">
                <paper-tab page-id="[[page.id]]">
                  <iron-icon class="tab-icon" icon="[[page.icon]]"></iron-icon>
                  [[page.label]]
                </paper-tab>
              </template>
            </paper-tabs>
          </app-toolbar>
        </app-header>

        <iron-pages
            id="pages"
            selected="[[currentPage.id]][[routeTail.path]]"
            attr-for-selected="page-id"
            fallback-selection="404"
            role="main">
          <div page-id=""></div>
          <template is="dom-repeat" items="[[env.viewdef.pages]]" as="page">
            <guild-view-page
                page-id$="[[page.id]]"
                page="[[page]]"
                env="[[env]]"></guild-view-page>
          </template>
          <guild-view-404-page page-id="404" path="[[route.path]]"></guild-view-404-page>
        </iron-pages>

      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    Polymer({
        is: 'guild-view',

        behaviors: [Guild.RunsListener],

        properties: {
            env: Object,
            route: String,
            currentPage: Object,
            queryParams: Object,
            narrow: Boolean,
            routeTail: Object,
            defaultPage: {
                type: String,
                computed: 'computeDefaultPage(env)'
            },
            fullscreenNotifyTarget: Object,
            notifyingFullscreenCanceled: {
                type: Boolean,
                value: false
            }
        },

        observers: [
            'pageChanged(currentPage.id)'
        ],

        listeners: {
            'fullscreen': 'handleFullscreen',
            'fullscreen-exit': 'handleFullscreenExit',
            'fullscreen-canceled': 'handleFullscreenCanceled'
        },

        ready: function() {
            Guild.Event.register(
                "run-selected",
                this.handleRunSelected.bind(this),
                this.env);
        },

        handleRuns: function(runs) {
            this.env.runs = runs;
            this.env.run = Guild.Run.runForId(this.env.runId, runs);
            Guild.Event.notify("env-runs-changed", this.env.runs, this.env)
            Guild.Event.notify("env-run-changed", this.env.run, this.env)
        },

        handleRunSelected: function(run) {
            if (run != null) {
                window.location = this.route.path + "?run=" + run.id;
            } else {
                this.runDeletedDialog();
            }
        },

        runDeletedDialog: function() {
            var dialog = this.$.dialog;
            var page = this.defaultPage;
            var nextUrl = page ? "/" + page.id : "/";
            dialog.contentHTML =
                "<div>The current run was deleted.</div>"
                + "<div><a href=\"javascript:window.location='"
                + nextUrl + "'\">Click here</a> to"
                +" refresh the view</div";
            dialog.open();
        },

        computeDefaultPage: function(env) {
            var pages = env.viewdef.pages;
            return pages.length > 0 ? pages[0] : null;
        },

        pageChanged: function(id, old) {
            // Debouncing to avoid dispatching twice - see Polymer issue
            // https://github.com/PolymerElements/app-route/issues/129
            this.debounce(id, function() {
                if (id == "") {
                    this.redirectToDefaultPage();
                } else {
                    this.resetPage(id);
                }
            });
        },

        redirectToDefaultPage: function() {
            var page = this.defaultPage();
            if (page) {
                var dialog = this.$.dialog;
                dialog.contentHTML = "Redirecting to " + page.label;
                dialog.open();
                window.location = "/" + page.id;
            }
        },

        resetPage: function(pageId) {
            var page = this.$$("guild-view-page[page-id=" + pageId + "]");
            if (page) {
                page.ensureGenerated();
            }
            document.body.scrollTop = document.documentElement.scrollTop = 0;
        },

        closeDrawer: function() {
            this.$.drawer.close();
        },

        handleFullscreen: function(e) {
            this.$.fullscreen.content = e.detail.content;
            this.fullscreenNotifyTarget = e.detail.notifyTarget;
            this.$.fullscreen.open();
        },

        handleFullscreenExit: function(e) {
            this.$.fullscreen.cancel();
        },

        handleFullscreenCanceled: function(e) {
            if (!this.notifyingFullscreenCanceled
                && this.fullscreenNotifyTarget) {
                this.notifyingFullscreenCanceled = true;
                this.fullscreenNotifyTarget.fire(e.type);
                this.notifyingFullscreenCanceled = false;
            }
        }
    });
  </script>
</dom-module>
