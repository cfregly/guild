<!--
Copyright 2016-2017 TensorHub, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../guild-imports/bootstrap-grid.html">
<link rel="import" href="../guild-project/guild-project.html">
<link rel="import" href="../guild-run/guild-run.html">
<link rel="import" href="../guild-run-select-page-header/guild-run-select-page-header.html">
<link rel="import" href="../guild-styles/guild-styles.html">
<link rel="import" href="../guild-view/guild-view-page-overlay.html">

<!-- Page components

     The scheme used to define components for this page is an unfortunate
     requirements due to Polymer's lack of data binding for dynamically
     created components (see https://github.com/Polymer/polymer/issues/1778).
     Components must be declared in the DOM to support data binding. Each
     possible component is wrapped in a template that tests specifically for
     an "element" value. Ideally we could generate the component dynamically,
     set the require attributes, and bidirectional data bindings would just
     work.

     The steps to add support for a new component:

     - Import the component definition

     - Add the component to the main or sidebar within a conditional template,
       based on where is may reasonably be used. If it can be reasonably used
       in both, you must add it to both.

     - Write a condition (e.g. isFoo) that tests specifically for the component
       element string.
-->
<link rel="import" href="../guild-attrs/guild-attrs.html">
<link rel="import" href="../guild-fields/guild-fields.html">
<link rel="import" href="../guild-flags/guild-flags.html">
<link rel="import" href="../guild-output/guild-output.html">
<link rel="import" href="../guild-series/guild-series.html">

<dom-module id="guild-train-page">
  <template>
    <style include="guild-row-styles"></style>
    <style>
     guild-run-select-page-header {
         flex: 1;
         margin-bottom: 18px;
     }

     .component {
         margin-bottom: 18px;
     }

     .bottom-spaced {
         margin-bottom: 0;
     }
    </style>

    <div class="container-fluid">
      <div class="row">
        <guild-run-select-page-header env="{{env}}"></guild-run-select-page-header>
      </div>

      <guild-view-page-overlay id="overlay"></guild-view-page-overlay>

      <div class="row row-20">
        <div id="main" class="col-lg-8 col-xl-9">
          <template is="dom-repeat" items="[[components.main]]" as="c">
            <div class="row row-20">
              <div class="component col-12">
                <template is="dom-if" if="[[isFields(c)]]">
                  <guild-fields env="[[env]]" active="[[active]]"></guild-fields>
                </template>
                <template is="dom-if" if="[[isSeries(c)]]">
                  <guild-series env="[[env]]" active="[[active]]"></guild-series>
                </template>
                <template is="dom-if" if="[[isOutput(c)]]">
                  <guild-output env="[[env]]" active="[[active]]"></guild-output>
                </template>
              </div>
            </div>
          </template>
        </div>
        <div id="sidebar" class="col-12 col-lg-4 col-xl-3">
          <template is="dom-repeat" items="[[components.sidebar]]" as="c">
            <div class="row row-20">
              <div class="component col-12">
                <template is="dom-if" if="[[isFlags(c)]]">
                  <guild-flags env="[[env]]"></guild-flags>
                </template>
                <template is="dom-if" if="[[isAttrs(c)]]">
                  <guild-attrs env="[[env]]"></guild-attrs>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>

    </div>
  </template>
  <script>
   Polymer({
       is: "guild-train-page",

       properties: {
           env: Object,
           active: Boolean,
           components: {
               computed: "computeComponents(env.project, env.selectedRun, env.runs)"
           }
       },

       observers: [
           "runChanged(env.selectedRun, env.runs)"
       ],

       computeComponents: function(project, selected, runs) {
           var run = Guild.Run.runForId(selected, runs);
           if (run) {
               var view = this.util.viewForRun(project, run);
               return {
                   main: this.viewComponents(view, "content", project),
                   sidebar: this.viewComponents(view, "sidebar", project)
               }
           } else {
               return [];
           }
       },

       viewComponents: function(view, type, project) {
           var refs = (view[type] || "").split(/\s+/);
           var comps = [];
           for (var i = 0; i < refs.length; i++) {
               var cdef = this.util.resolveContent(refs[i], project);
               if (cdef) {
                   comps.push(cdef);
               }
           }
           return comps;
       },

       isFields: function(c) {
           return c.element == "guild-fields";
       },

       isSeries: function(c) {
           return c.element == "guild-series";
       },

       isAttrs: function(c) {
           return c.element == "guild-attrs";
       },

       isFlags: function(c) {
           return c.element == "guild-flags";
       },

       isOutput: function(c) {
           return c.element == "guild-output";
       },

       runChanged: function(selected, runs) {
           var run = Guild.Run.runForId(selected, runs);
           if (run) {
               if (this.lastContentRun != run.id) {
                   this.lastContentRun = run.id;
                   this.$.overlay.close();
               }
           } else {
               // run was deleted
               this.$.overlay.open();
           }
       },

       util: new function() {

           this.viewForRun = function(project, run) {
               return Guild.Project.namedSectionOrDefault(
                   project,
                   "train-view",
                   run.model);
           };

           this.resolveContent = function(name, project) {
               return Guild.Project.namedSection(project, "component", name);
           };
       }
   });
  </script>
</dom-module>
