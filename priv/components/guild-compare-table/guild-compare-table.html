<link rel="import" href="../fa-awesome/fa-awesome.html">
<link rel="import" href="../guild-data-table/default-styles.html">
<link rel="import" href="../guild-data-table/guild-data-table.html">
<link rel="import" href="../guild-data/guild-data-listener.html">
<link rel="import" href="../guild-imports/d3.html">
<link rel="import" href="../guild-run/guild-run.html">
<link rel="import" href="../guild-styles/guild-styles.html">
<link rel="import" href="../guild-util/guild-util.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">

<dom-module id="guild-compare-table">
  <template>
    <style include="guild-run-status-styles"></style>
    <style>
     :root {
         --data-table-cell: {
             padding: 0 5px;
             font-size: 14px;
         };
         --data-table-sort-icon: {
             padding: 0;
             width: 20px;
         };
     }
     .status-header {
         margin-left: -4px;
         width: 0;
     }
     .status-cell {
         margin-left: 5px;
     }
     .date {
         white-space: nowrap;
     }
    </style>
    <guild-data-table
        id="table"
        selection-enabled
        on-selecting-item="runSelected">
      <data-table-column
          flex="0"
          width="50px"
          padding="0 12px"
          sort-by="status.sort">
        <template is="header">
          <div class="status-header"></div>
        </template>
        <template>
          <div class="status-cell">
            <fa-awesome
                class$="[[item.status.iconClass]]"
                spin$="[[item.status.spin]]"
                icon="[[item.status.icon]]"
                size="22">
            </fa-awesome>
            <paper-tooltip
                position="right"
                animation-delay="250">[[item.status.label]]</paper-tooltip>
          </div>
        </template>
      </data-table-column>
      <data-table-column
          name="Time"
          flex="0"
          width="10em"
          sort-by="index">
        <template><span class="date">[[formatTime(item.run.started)]]</span></template>
      </data-table-column>
      <data-table-column
          name="Model"
          flex="1"
          sort-by="run.model"
          filter-by="run.model">
        <template>[[item.run.model]]</template>
      </data-table-column>
    </guild-data-table>
    <div class="toggles">
      <paper-toggle-button checked="{{showFailed}}">Show failed runs</paper-toggle-button>
    </div>
  </template>
  <script>
   Polymer({
       is: "guild-compare-table",

       behaviors: [Guild.DataListener],

       properties: {
           env: Object,
           fields: Array,
           dataSource: {
               type: String,
               computed: 'computeDataSource(fields)'
           },
           timeFormat: {
               type: Object,
               value: function() {
                   return d3.time.format("%b %d %H:%M:%S");
               }
           },
           showFailed: {
               type: Boolean,
               value: false,
               observer: 'showFailedChanged'
           }
       },

       attached: function() {
           this.initStatusFilter();
           this.initFieldColumns();
       },

       initStatusFilter: function() {
           this.$.table.push('filter', {
               path: 'status.label',
               filter: this.statusFilter()
           });
       },

       statusFilter: function() {
           return this.showFailed ? "" : "Completed|Running";
       },

       initFieldColumns: function() {
           var table = this.$.table;
           this.fields.forEach(function(field, index) {
               var fieldName = "f" + index;
               var col = document.createElement("data-table-column");
               col.name = field.label;
               col.sortBy = fieldName + ".sort";
               col.filterBy = fieldName + ".value";
               var template = document.createElement("template");
               template.innerHTML = "[[item." + fieldName + ".value]]";
               col._setTemplate(template);
               Polymer.dom(table).appendChild(col);
           });
       },

       computeDataSource: function(fields) {
           var sources = new Set();
           fields.forEach(function(field) {
               field.sources.split(",").forEach(function(source) {
                   sources.add(source);
               });
           });
           if (sources.size > 0) {
               return "compare?sources=" + Array.from(sources).join(",");
           } else {
               return "compare"
           }
       },

       formatTime: function(epoch) {
           return this.timeFormat(new Date(epoch));
       },

       handleData: function(data) {
           var table = this.$.table;
           table.items = this.formatItems(data);
       },

       formatItems: function(data) {
           var itemBase = this.itemBase.bind(this);
           var itemFields = this.itemFields.bind(this);
           return data.map(function(item, index) {
               return Object.assign(
                   itemBase(item, index),
                   itemFields(item));
           });
       },

       itemBase: function(item, index) {
           return {
               run: item.run,
               status: this.runStatus(item.run),
               index: index
           }
       },

       runStatus: function(run) {
           var status = Guild.Run.runStatus(run);
           status.sort = this.statusSort(status);
           return status;
       },

       statusSort: function(status) {
           var label = status.label;
           if (label == "Running") {
               return 0;
           } else if (label == "Completed") {
               return 1;
           } else if (label == "Terminated") {
               return 2;
           } else if (label == "Error") {
               return 3;
           } else {
               return 4;
           }
       },

       itemFields: function(item) {
           var fields = {};
           var fieldValue = this.fieldValue.bind(this);
           this.fields.forEach(function(field, index) {
               // field.sources here is spelled correctly - we're assuming
               // for the time being that field.sources will only every be
               // a single source and can be used to lookup corresponding
               // data in item.
               var data = item[field.sources];
               var name = "f" + index;
               fields[name] = fieldValue(data, field);
           });
           return fields;
       },

       fieldValue: function(data, field) {
           var raw = this.fieldRawValue(data, field);
           var sort = raw == undefined ? null: raw;
           var formatted = this.fieldFormattedValue(raw, field);
           return {sort: sort, value: formatted};
       },

       fieldRawValue: function(data, field) {
           if (field.attribute) {
               return data[field.attribute];
           } else if (field.reduce) {
               var reduce = Guild.Reduce[field.reduce];
               if (reduce) {
                   var reduced = reduce(data);
                   return reduced[Object.keys(reduced)[0]];
               }
           }
           return undefined;
       },

       fieldFormattedValue: function(raw, field) {
           return field.format
                ? Guild.Util.tryFormat(raw, field.format)
                : raw;
       },

       runSelected: function(e) {
           var page1 = this.env.viewdef.pages[0].id;
           var runId = e.detail.item.run.id;
           window.location = "/" + page1 + "?run=" + runId;
       },

       showFailedChanged: function(val, old) {
           if (old != undefined) {
               this.$.table.set("filter.0.filter", this.statusFilter());
           }
       }
   });
  </script>
</dom-module>
